<script>
	import { browser } from '$app/environment';
	import { afterNavigate } from '$app/navigation';
	import { base } from '$app/paths';
	import { page } from '$app/stores';
	import { click_outside, focus_outside, root_scroll } from '$lib/actions';
	import Icon from '$lib/components/Icon.svelte';
	import { mql, nav_open, overlay_open, reduced_motion } from '$lib/stores';
	import { afterUpdate, createEventDispatcher, onMount, tick } from 'svelte';
	import { expoOut } from 'svelte/easing';
	import { slide } from 'svelte/transition';

	/** @type {import('./types').Page} */
	export let details;

	const dispatch = createEventDispatcher();

	/** @type {string} */
	let hash = '';

	/** @type {number} */
	let height = 0;

	/** @type {HTMLElement} */
	let content;

	/** @type {NodeListOf<HTMLElement>} */
	let headings;

	/** @type {number[]} */
	let positions = [];

	/** @type {HTMLElement} */
	let containerEl;

	let show_contents = false;

	let mobile_z_index = 2;

	const is_mobile = mql('(max-width: 1200px)');

	let mobile_menu_open = false;

	$: pathname = $page.url.pathname;

	$: {
		pathname;

		emulate_autoscroll();
	}

	$: {
		$overlay_open = mobile_menu_open;
	}

	onMount(async () => {
		await document.fonts.ready;
		update();
		highlight();
	});

	afterUpdate(() => {
		// bit of a hack â€” prevent sidebar scrolling if
		// TOC is open on mobile, or scroll came from within sidebar
		if (show_contents && window.innerWidth < 832) return;
		const active = containerEl.querySelector('.active');
		if (active) {
			const { top, bottom } = active.getBoundingClientRect();
			const min = 100;
			const max = window.innerHeight - 100;

			if (top > max) {
				containerEl.scrollBy({
					top: top - max,
					left: 0,
					behavior: 'smooth'
				});
			} else if (bottom < min) {
				containerEl.scrollBy({
					top: bottom - min,
					left: 0,
					behavior: 'smooth'
				});
			}
		}
	});

	afterNavigate(() => {
		update();
		highlight();

		mobile_menu_open = false;
	});

	async function emulate_autoscroll() {
		if (browser) {
			const hash = $page.url.hash.replace(/^#/, '');

			await tick();

			const el = document.getElementById(hash);

			el?.scrollIntoView({ behavior: 'auto', block: 'start' });
		}
	}

	async function update() {
		const contentEl = /** @type {HTMLElement | null} */ (document.querySelector('.content'));

		if (!contentEl) return;

		content = contentEl;

		const { top } = content.getBoundingClientRect();
		headings = content.querySelectorAll('h2[id]');
		positions = Array.from(headings).map((heading) => {
			const style = getComputedStyle(heading);
			return heading.getBoundingClientRect().top - parseFloat(style.scrollMarginTop) - top;
		});
		height = window.innerHeight;
	}

	function highlight() {
		const { top, bottom } = content.getBoundingClientRect();
		let i = headings.length;
		while (i--) {
			if (bottom - height < 50 || positions[i] + top < 100) {
				const heading = headings[i];
				hash = `#${heading.id}`;
				return;
			}
		}
		hash = '';
	}

	/** @param {URL} url */
	function select(url) {
		// belt...
		setTimeout(() => {
			hash = url.hash;
		});
		// ...and braces
		window.addEventListener(
			'scroll',
			() => {
				hash = url.hash;
			},
			{ once: true }
		);
	}

	function on_link_click() {
		mobile_menu_open = false;
		dispatch('select');
	}
</script>

<svelte:window
	use:root_scroll={highlight}
	on:resize={update}
	on:hashchange={() => select($page.url)}
/>

<aside
	class="on-this-page"
	style:z-index={mobile_z_index}
	bind:this={containerEl}
	use:click_outside={() => $is_mobile && (mobile_menu_open = false)}
	use:focus_outside={() => $is_mobile && (mobile_menu_open = false)}
>
	<button class="heading" on:click={() => (mobile_menu_open = !mobile_menu_open)}>
		<span class="h2">On this page</span>

		<span class="expand-icon" class:inverted={mobile_menu_open}>
			<Icon name="chevron-down" />
		</span>
	</button>

	{#if (browser && !$is_mobile) || ($is_mobile && mobile_menu_open)}
		<nav
			aria-label="On this page"
			transition:slide={{ axis: 'y', easing: expoOut, duration: $reduced_motion ? 0 : 400 }}
			on:introstart={() => mobile_menu_open && (mobile_z_index = 101)}
			on:outrostart={async () => {
				await tick();

				if (!mobile_menu_open && $nav_open) {
					mobile_z_index = 2;
				}
			}}
			on:outroend={() => !mobile_menu_open && (mobile_z_index = 2)}
		>
			<ul>
				<li>
					<a href="{base}/docs/{details.slug}" class:active={hash === ''} on:click={on_link_click}
						>{details.title}</a
					>
				</li>
				{#each details.sections as { title, slug }}
					<li>
						<a href={`#${slug}`} class:active={`#${slug}` === hash} on:click={on_link_click}>
							{title}
						</a>
					</li>
				{/each}
			</ul>
		</nav>
	{/if}
</aside>

<style>
	* {
		box-sizing: border-box;
	}

	.on-this-page {
		display: var(--on-this-page-display);
		position: fixed;
		padding: var(--sk-page-padding-top) var(--sk-page-padding-side) 0 0;
		width: min(280px, calc(var(--sidebar-width) - var(--sk-page-padding-side)));
		height: calc(100vh - var(--sk-nav-height) - var(--sk-page-padding-top));
		top: var(--sk-nav-height);
		left: calc(100vw - (var(--sidebar-width)));
		overflow-y: auto;
	}

	.heading {
		position: relative;

		width: 100%;

		display: grid;
		align-items: center;
		grid-template-columns: 1fr auto;
		gap: 0.75rem;

		padding: 1rem 0.75rem;
	}

	.h2 {
		text-transform: uppercase;
		font-size: 1.4rem !important;
		font-weight: 400;
		margin: 0 !important;
		padding: 0 !important;
		color: var(--sk-text-3);
		text-align: start;
	}

	.heading :global(svg) {
		display: none;

		transform: translateY(-1px);
	}

	.expand-icon :global(svg) {
		transition: transform 0.4s var(--quint-out);
		transform-origin: center;
	}

	.expand-icon.inverted :global(svg) {
		transform: rotate3d(0, 0, 1, 180deg);
	}

	ul {
		list-style: none !important;
		margin-left: 0 !important;
	}

	li {
		margin: 0.2rem !important;
	}

	li::before {
		content: none !important;
	}

	a {
		display: block;
		padding: 0.3rem 0.5rem;
		color: var(--sk-text-3) !important;
		border-left: 2px solid transparent;
		box-shadow: none !important;

		transition: 0.4s var(--quint-out) !important;
		transition-property: background, border-left;
	}

	a:hover {
		text-decoration: none;
		background: var(--sk-back-3);
	}

	a.active {
		background: var(--sk-back-3);
		border-left-color: var(--sk-theme-1);
	}

	@media screen and (max-width: 1200px) {
		.on-this-page {
			position: relative;
			top: 0;
			left: 0;
			z-index: 99;

			display: block;

			width: 100%;
			height: auto;

			margin-top: 3rem;
			padding: 0.5rem;

			border-radius: var(--sk-border-radius);
			/* box-shadow: 0px 0px 14px rgba(0, 0, 0, 0.1); */

			overflow-y: initial;

			background-color: var(--sk-back-4);
		}

		.h2 {
			font-size: var(--sk-text-s) !important;
			line-height: 1;

			padding: 0.8rem 1rem;

			border: none;
		}

		.heading :global(svg) {
			display: block;
		}

		nav {
			position: absolute;
			top: 48px;
			left: 0;

			width: 100%;
			padding-bottom: 1rem;

			background-color: var(--sk-back-4);

			border-radius: 0 0 var(--sk-border-radius) var(--sk-border-radius);
		}

		ul {
			margin: 0 !important;

			display: grid;
			gap: 0.5rem;
		}

		li {
			margin: 0rem !important;
		}

		li:first-child {
			display: none;
		}

		a {
			padding: 0.4rem 0.75rem;
			box-sizing: border-box;

			color: var(--sk-text-2) !important;
		}

		a.active {
			background-color: transparent;
			border-left: 0;
		}

		a:hover {
			text-decoration: none;
			background-color: initial;
		}
	}
</style>
